# Handoff - Resonance
**Date:** 2025-12-12 20:45 | **Branch:** main

## Summary
Domain model architecture complete and merged. LLM integration architecture fully designed but not yet implemented. Ready to begin implementing the World Intelligence system (WorldQuery, QueryResponse, InfoCapability, QueryContext models and services).

## Completed
- Domain models refactored with interface + class pattern (PR #43 merged)
- 10 domain models: User, World, Tag, Template, PropertyDefinition, Property, EntityDefinition, Entity, RelationshipDefinition, Relationship
- Branded IDs for type safety
- Value objects: EntityReference, PropertyUsage, EmbeddingChunk
- Files: `packages/backend/src/domain/models/*`, `packages/backend/src/domain/value-objects/*`
- LLM integration architecture fully designed (not implemented)

## In Progress / Blocked
- **Next:** Implement LLM integration domain models
- No blockers

## Key Decisions
1. **Domain defines LLM contract**: QueryResponse = Answer | NeedsMoreInfo. Domain handles retry logic (3 attempts with correction prompt).
2. **RAG is domain logic**: RetrievalStrategy defines what/how much. Domain says WHAT, infra says HOW.
3. **Dynamic capabilities**: InfoCapability contextual. `constrainToContextIds` prevents hallucination via enum injection.
4. **NeedsMoreInfo loop**: Max 3 requests. Track fulfilled to prevent loops. Force answer if stuck.
5. **QueryContext rich model**: `markExpanded()`, `merge()`, `hasExpandableEntities()`. Tracks `fullyExpandedEntityIds` for O(1) resolution.

## Next Steps
1. Create `domain/models/world-query.ts` - WorldQuery model
2. Create `domain/models/query-response.ts` - Answer, NeedsMoreInfo types
3. Create `domain/models/info-capability.ts` - InfoCapability, InfoRequest, CapabilityParameter
4. Create `domain/models/query-context.ts` - QueryContext class with behavior
5. Create `domain/capabilities.ts` - capability definitions (EXPAND_ENTITIES, SEARCH, etc.)
6. Create ports: IWorldIntelligence, IVectorSearch, IGraphQuery
7. Create services: WorldIntelligenceService, ContextBuilderService, CapabilityResolver, InfoRequestFulfiller

## Memory IDs
- 8a9b1432-b64a-481d-a68c-97de0994be38 (Domain model summary)
- e1e7909d-9761-4963-a2f8-96372de9df5e (LLM integration architecture)
- 3a63ae8e-8260-48fe-9610-32e1e8b85e86 (RAG strategy as domain logic)
- a0703dee-386b-431a-8725-b0eb6c0973eb (Dynamic capability system)
- 050ad1e4-9513-495e-96c7-373eb6ecaffd (NeedsMoreInfo loop)
- 5ba7e6e0-71f4-4572-af7c-1da1e759d7cc (QueryContext rich model)
