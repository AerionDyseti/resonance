# Handoff - Resonance
**Date:** 2025-12-17 22:30 | **Branch:** feat/backend-infrastructure-world-domain

## Summary
Extended the lotr-scraper to support artifacts and events, integrated LotR/Middle-earth data into the Resonance experiment testing harness, and tuned the intelligence system prompt for better RAG behavior. The testing harness now has interactive REPL mode with spinner feedback.

## Completed
- Extended lotr-scraper with `artifacts` and `events` entity types
  - `~/dev/lotr-scraper/src/config/categories.ts` - added artifact/event types
  - `~/dev/lotr-scraper/src/config/sources.ts` - added wiki categories for both sources
  - `~/dev/lotr-scraper/src/fetch-specific.ts` - new script to fetch individual articles by name
- Scraped 819 LotR entities: 370 characters, 235 locations, 97 events, 74 artifacts, 43 organizations
- Integrated LotR data into experiment harness
  - `packages/experiment/test-data-loader.ts` - added `initializeLotrData()`, `LOTR_WORLD_ID`, supports 5 entity types
  - `packages/experiment/intelligence-orchestrator.ts` - fixed worldId detection, tuned system prompt
  - `packages/experiment/run-query.ts` - added `--lotr` flag, interactive REPL mode, spinner
- Created test questions and gap analysis
  - `docs/lotr-test-questions.md` - 37 questions designed to test RAG system
  - `docs/lotr-entities-gap-analysis.md` - maps entities needed per question

## Key Decisions
- **System prompt grounding**: LLM must pretend it knows nothing about the world except provided context, but IS encouraged to make inferences, use genre tropes, and connect facts
- **Partial answers preferred**: Low confidence = "partial answer with incomplete info" not failure. "A partial answer is ALWAYS better than 'I couldn't find anything'"
- **WorldId auto-detection**: Orchestrator detects worldId from first loaded entity rather than hardcoding

## Insights & Patterns
- The Gondolin wiki entry is missing the actual Seven Names list (text cut off at "a guard recites to him:") - useful demo of RAG limitations with incomplete source data
- Initial search was failing because hardcoded `TEST_WORLD_ID` didn't match `LOTR_WORLD_ID` on loaded entities

## Next Steps
- Test the intelligence system with the 37 test questions
- Consider improving wiki scraper parsing for formatted lists/tables
- May need to tune max iterations or add more search strategies

## Working Context
- Key files:
  - `packages/experiment/run-query.ts` - main entry point
  - `packages/experiment/intelligence-orchestrator.ts` - RAG loop + system prompt
  - `packages/experiment/test-data-loader.ts` - data loading
  - `~/dev/lotr-scraper/output/` - scraped LotR data
- Commands:
  - `bun run packages/experiment/run-query.ts --lotr` - interactive LotR mode
  - `bun run packages/experiment/run-query.ts --lotr "question"` - single query
  - `bun run packages/experiment/verify-lotr-data.ts` - verify data loading
  - `bun run packages/experiment/test-search.ts` - test semantic search

## Memory IDs
Vector memory unavailable - memories not stored.
